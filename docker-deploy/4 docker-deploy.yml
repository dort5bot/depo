name: ðŸ³ Docker Build & Deploy (Staging â†’ Production)
# v5
# iÅŸlem sÄ±rasÄ±: 
    # 1) .gitignore
    # 2) .dockerignore
    # 3) Dockerfile
    # 4) .github/workflows/docker-deploy.yml

# Tek VPS, multi-container, zero-downtime mantÄ±ÄŸÄ±na uygun
#1. Multi-container deploy: Tek VPS Ã¼zerinde staging/prod iÃ§in birden fazla container (primary, secondary) Ã§alÄ±ÅŸabilir.
#2. Dinamik port ve isimlendirme: Port ve container adÄ± otomatik atanÄ±r â†’ Ã§akÄ±ÅŸma riski yok.
#3. Staging otomatik, production manuel: GÃ¼venli ve profesyonel CI/CD sÃ¼reci.
#4. ÃœÃ§ platform destekli: Oracle, Hetzner, Render.
  # ORACLE_SSH_KEY, ORACLE_HOST, ORACLE_USER
  # HETZNER_SSH_KEY, HETZNER_HOST, HETZNER_USER
  # RENDER_DEPLOY_HOOK
  # GitHub â†’ Settings â†’ Secrets â†’ Actions
#5. Dummy pytest: Pipelineâ€™Ä±n saÄŸ
#6.


on:
  push:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: docker-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  BASE_CONTAINER_NAME: ${{ github.event.repository.name }}-${{ github.ref_name }}

  ORACLE_SSH_KEY: ${{ secrets.ORACLE_SSH_KEY }}
  ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
  ORACLE_USER: ${{ secrets.ORACLE_USER }}

  HETZNER_SSH_KEY: ${{ secrets.HETZNER_SSH_KEY }}
  HETZNER_HOST: ${{ secrets.HETZNER_HOST }}
  HETZNER_USER: ${{ secrets.HETZNER_USER }}

  RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}

# -------------------------------------------------
# 1ï¸âƒ£ BUILD + TEST + PUSH
# -------------------------------------------------
jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push STAGING image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Dummy Pytest
        run: |
          pip install pytest
          mkdir -p tests
          echo "def test_ok(): assert 1 + 1 == 2" > tests/test_dummy.py
          pytest tests/

# -------------------------------------------------
# 2ï¸âƒ£ STAGING DEPLOY (AUTO)
# -------------------------------------------------
  deploy-staging:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    timeout-minutes: 40

    steps:
      - name: Deploy to Oracle (staging)
        if: env.ORACLE_SSH_KEY != '' && env.ORACLE_HOST != ''
        env:
          SSH_KEY: ${{ env.ORACLE_SSH_KEY }}
        run: |
          set -e
          USER="${ORACLE_USER:-ubuntu}"
          PORTS=(3001 3002 3003)

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$ORACLE_HOST" >> ~/.ssh/known_hosts

          ssh $USER@$ORACLE_HOST << EOF
            set -e
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging"

            for i in {0..2}; do
              NAME="${{ env.BASE_CONTAINER_NAME }}-staging-\$i"
              PORT="\${PORTS[\$i]}"
              docker pull "\$IMAGE"
              docker stop "\$NAME" 2>/dev/null || true
              docker rm "\$NAME" 2>/dev/null || true
              docker run -d --restart unless-stopped \
                --name "\$NAME" -p "\$PORT":3000 "\$IMAGE"
            done
          EOF

      - name: Deploy to Hetzner (staging)
        if: env.HETZNER_SSH_KEY != '' && env.HETZNER_HOST != ''
        env:
          SSH_KEY: ${{ env.HETZNER_SSH_KEY }}
        run: |
          set -e
          USER="${HETZNER_USER:-root}"
          PORTS=(3001 3002 3003)

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$HETZNER_HOST" >> ~/.ssh/known_hosts

          ssh $USER@$HETZNER_HOST << EOF
            set -e
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging"

            for i in {0..2}; do
              NAME="${{ env.BASE_CONTAINER_NAME }}-staging-\$i"
              PORT="\${PORTS[\$i]}"
              docker pull "\$IMAGE"
              docker stop "\$NAME" 2>/dev/null || true
              docker rm "\$NAME" 2>/dev/null || true
              docker run -d --restart unless-stopped \
                --name "\$NAME" -p "\$PORT":3000 "\$IMAGE"
            done
          EOF

      - name: Deploy to Render (staging)
        if: env.RENDER_DEPLOY_HOOK != ''
        run: curl -X POST "$RENDER_DEPLOY_HOOK"

# -------------------------------------------------
# 3ï¸âƒ£ PRODUCTION BUILD + DEPLOY (MANUAL)
# -------------------------------------------------
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 40
    permissions:
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push PRODUCTION image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Oracle (prod)
        if: env.ORACLE_SSH_KEY != '' && env.ORACLE_HOST != ''
        env:
          SSH_KEY: ${{ env.ORACLE_SSH_KEY }}
        run: |
          USER="${ORACLE_USER:-ubuntu}"
          PORTS=(3000 3001)

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$ORACLE_HOST" >> ~/.ssh/known_hosts

          ssh $USER@$ORACLE_HOST << EOF
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            for i in {0..1}; do
              NAME="${{ env.BASE_CONTAINER_NAME }}-prod-\$i"
              PORT="\${PORTS[\$i]}"
              docker pull "\$IMAGE"
              docker stop "\$NAME" 2>/dev/null || true
              docker rm "\$NAME" 2>/dev/null || true
              docker run -d --restart unless-stopped \
                --name "\$NAME" -p "\$PORT":3000 "\$IMAGE"
            done
          EOF

      - name: Deploy to Hetzner (prod)
        if: env.HETZNER_SSH_KEY != '' && env.HETZNER_HOST != ''
        env:
          SSH_KEY: ${{ env.HETZNER_SSH_KEY }}
        run: |
          USER="${HETZNER_USER:-root}"
          PORTS=(3000 3001)

          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$HETZNER_HOST" >> ~/.ssh/known_hosts

          ssh $USER@$HETZNER_HOST << EOF
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            for i in {0..1}; do
              NAME="${{ env.BASE_CONTAINER_NAME }}-prod-\$i"
              PORT="\${PORTS[\$i]}"
              docker pull "\$IMAGE"
              docker stop "\$NAME" 2>/dev/null || true
              docker rm "\$NAME" 2>/dev/null || true
              docker run -d --restart unless-stopped \
                --name "\$NAME" -p "\$PORT":3000 "\$IMAGE"
            done
          EOF

      - name: Deploy to Render (prod)
        if: env.RENDER_DEPLOY_HOOK != ''
        run: curl -X POST "$RENDER_DEPLOY_HOOK"
